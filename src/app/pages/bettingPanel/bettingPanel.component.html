<app-page-loader-bouncing [loading]="loading"></app-page-loader-bouncing>
<nz-layout class="layout">
  <nz-sider nzCollapsible [class.fixed]="isMobile" nzBreakpoint="lg" [nzCollapsedWidth]="0" [nzTrigger]="null" [(nzCollapsed)]="isCollapsed">
    <ul nz-menu nzTheme="dark" nzMode="inline">
      <li nz-menu-item routerLink="/">
        <i nz-icon nzType="home"></i>
        <span>Home</span>
      </li>
      <li nz-menu-item (click)="openDrawer(drawerBets, {})">
        <i nz-icon nzType="file-search"></i>
        <span>{{'BETTING_PANEL.TOPBAR.SEARCH_TICKET'|translate}}</span>
      </li>
      <li nz-menu-item (click)="openDrawer(drawerResumeSells, {})">
        <i nz-icon nzType="wallet"></i>
        <span>{{'BETTING_PANEL.TOPBAR.CASH_DESK_CLOSING'|translate}}</span>
      </li>
      <li nz-menu-item (click)="openDrawer(drawerPayBet, {})">
        <i nz-icon nzType="audit"></i>
        <span>{{'BETTING_PANEL.TOPBAR.PAY_TICKET'|translate}}</span>
      </li>
      <li nz-menu-item (click)="openDrawer(drawerLotteryLimits, {})">
        <i nz-icon nzType="dollar"></i>
        <span>{{'BETTING_PANEL.TOPBAR.LOTTERY_LIMITS'|translate}}</span>
      </li>
      <li nz-menu-item (click)="openDrawer(drawerHelp, {})">
        <i nz-icon nzType="question"></i>
        <span>{{'BETTING_PANEL.TOPBAR.HELP'|translate}}</span>
      </li>
      <li nz-menu-item (click)="openDrawer(drawerChat, {})">
        <nz-badge class="nz-badge-custom" [nzDot]="messages.length > 0" [nzShowZero]="false">
          <i nz-icon nzType="message"></i>
        </nz-badge>
        <span>{{'BETTING_PANEL.TOPBAR.CHAT'|translate}}</span>
      </li>
      <li nz-menu-item (click)="isCollapsed = !isCollapsed" *ngIf="isMobile" style="display: flex;
    align-items: center;
    justify-content: center;
    background-color: #034a8e;
    color: white;">
        <i nz-icon nzType="left"></i>
      </li>

    </ul>
  </nz-sider>
  <nz-layout style="overflow: auto;">
    <nz-header>
      <div class="header">
        <div class="header-left">
          <i class="trigger" nz-icon [nzType]="isCollapsed ? 'menu-unfold' : 'menu-fold'"
             (click)="isCollapsed = !isCollapsed"></i>
          <div class="top-content-topbar" *ngIf="!isMobile">
            <span class="widget total">
            <i nz-icon nzTheme="outline" nzType="shopping-cart"></i>
              <b>{{('BETTING_PANEL.TOPBAR.TOTAL'|translate).toUpperCase()}}: ${{getSumBets(plays)}}</b>
            </span>
            <span class="widget date">
            <i nz-icon nzTheme="outline" nzType="clock-circle"></i>
              {{now | date: 'dd/MM/yyyy HH:mm'}}
            </span>
          </div>
        </div>
        <div class="header-right">
          <button nz-button (click)="cleanAll()" [disabled]="this.plays.length <= 0">
            <i nz-icon nzTheme="outline" nzType="clear"></i>
            {{('BETTING_PANEL.TOPBAR.CLEAN'|translate).toUpperCase()}}
          </button>
          <button [nzType]="'primary'" nz-button (click)="onSubmitBet()" [disabled]="this.plays.length <= 0">
            <i nz-icon nzTheme="outline" nzType="printer"></i>
            {{('BETTING_PANEL.TOPBAR.CONFIRM'|translate).toUpperCase()}}
          </button>
        </div>
      </div>
    </nz-header>
    <nz-content>
      <div class="inner-content top-content" *ngIf="isMobile">
        <span class="widget total">
        <i nz-icon nzTheme="outline" nzType="shopping-cart"></i>
          {{'BETTING_PANEL.TOPBAR.TOTAL'|translate}}: ${{getSumBets(plays)}}
        </span>
        <span class="widget date">
        <i nz-icon nzTheme="outline" nzType="clock-circle"></i>
          {{now | date: 'dd/MM/yyyy HH:mm'}}
        </span>
      </div>
      <div class="inner-content inputs-content">
        <div nz-row [nzGutter]="5">
          <div nz-col nzXs="9" nzSm="5" nzMd="5" nzLg="5" nzXl="5">
            <input #inputNumber class="play-input"
                   (ngModelChange)="searchLimit()"
                   (keyup.enter)="onKeyEnterNumber()" [(ngModel)]="number"
                   autofocus nz-input (input)="regexPlay(inputNumber)" placeholder="JUGADA"/>
          </div>
          <div nz-col nzXs="6" nzSm="5" nzMd="5" nzLg="5" nzXl="5">
            <input #inputLimit [disabled]="true" [type]="'number'" [value]="limit" class="right-input"
                   nz-input placeholder="LIMITE" readonly/>
          </div>
          <div nz-col nzXs="9" nzSm="5" nzMd="5" nzLg="5" nzXl="5">
            <nz-input-number #inputAmount (keyup.enter)="onKeyEnter()" [(ngModel)]="amount"
                             class="right-input" [nzMin]="0" [name]="'Monto'|translate"
                             [nzPlaceHolder]="'MONTO'| translate"></nz-input-number>
          </div>
          <div nz-col nzXs="12" nzSm="5" nzMd="5" nzLg="5" nzXl="5">
            <button nz-button (click)="onCheckSuperPale()" [class.selected]="this.superPale" class="super-pale">
              SUPERPALE
            </button>
          </div>
          <div nz-col nzXs="12" nzSm="4" nzMd="4" nzLg="4" nzXl="4">
            <button class="play-button" nz-button (click)="onKeyEnter()" [disabled]="disabledBet()">
              <i nz-icon nzTheme="outline" [nzType]="loadingSearchLimit ? 'loading' : 'caret-right'"></i>
            </button>
          </div>
        </div>
      </div>


      <div nz-row [nzGutter]="5">
        <div nz-col nzXs="24" nzSm="12" nzMd="12" nzLg="12" nzXl="12">
          <div class="inner-content lottery-panel">
            <div class="lottery-panel-header">
              <div class="row-style panel-container" nz-row>
                <div class="center-column" nz-col nzSpan="12">
                  LOTERIA
                </div>
                <div class="center-column" nz-col nzSpan="10">
                  CIERRE
                </div>
                <div class="center-column" nz-col nzSpan="2">
                  <i *ngIf="reloadingLotteries" nz-icon nzTheme="outline" nzType="loading"></i>
                </div>
              </div>
            </div>
            <div class="lottery-panel-body">
              <div
                (click)="(lottery.status && lottery.leftTime > 0) && onChangeLottery(lottery, !this.selectedLotteries.includes(lottery._id.toString()))"
                *ngFor="let lottery of lotteries"
                [class.closed]="!lottery.status || !lottery.leftTime"
                [style]="{backgroundColor: lottery.color}" class="lottery">
                <div class="row-style panel-container" nz-row>
                  <div nz-col nzSpan="12">{{lottery.name}}</div>
                  <div class="center-column" nz-col nzSpan="10">
                    <i *ngIf="lottery.status && lottery.leftTime > 0" class="icon primary" nz-icon
                       nzTheme="outline"
                       nzType="check-circle" style="margin-right: 5px"></i>
                    <i *ngIf="!lottery.status || !lottery.leftTime" class="icon" nz-icon nzTheme="outline" nzType="lock"
                       style="margin-right: 5px"></i>

                    <!--<nz-countdown #cd [nzValue]="lottery.leftTime" [nzFormat]="'HH:mm'" *ngIf="lottery.leftTime"></nz-countdown>-->
                    <countdown #cd (event)="onChangeCounter($event, lottery)" *ngIf="lottery.leftTime"
                               [config]="{leftTime:lottery.leftTime, format: 'HH:mm:ss'}"></countdown>
                  </div>
                  <div class="center-column last-column" nz-col nzSpan="2">
                    <label (nzCheckedChange)="onChangeLottery(lottery, $event)"
                           [nzChecked]="this.selectedLotteries.includes(lottery._id.toString())"
                           [nzDisabled]="!lottery.status || !lottery.leftTime"
                           nz-checkbox></label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div nz-col nzXs="24" nzSm="12" nzMd="12" nzLg="12" nzXl="12" *ngIf="!isMobile">
          <div class="inner-content last-plays-panel">
            <div class="last-plays-panel-header">
              <div class="row-style panel-container" nz-row style="width: 100%">
                <div class="center-column" nz-col nzSpan="12">
                  ULT. RESULTADOS
                </div>
                <div class="center-column" nz-col nzSpan="12"
                     style="justify-content: flex-end; padding-right: 20px">
                  <i *ngIf="reloadingResults" nz-icon nzTheme="outline" nzType="loading"></i>
                </div>
              </div>
            </div>
            <div class="last-plays-panel-body">
              <div *ngFor="let result of lastResults" class="play">
                <div class="row-style panel-container" nz-row>
                  <div class="center-column" nz-col nzSpan="8"
                       style="justify-content: flex-start;">{{result.lotteryName}}</div>
                  <div *ngIf="result.draw" class="center-column" nz-col nzSpan="8"
                       style="justify-content: flex-end">
                    {{result.date | date: 'dd/MM/yyyy'}}
                  </div>
                  <div *ngIf="result.draw" class="center-column" nz-col nzSpan="8"
                       style="justify-content: flex-end">
                    <app-ball *ngIf="result.draw.first || result.draw.first === 0" [background]="'red'" [size]="'tiny'"
                              [title]="this.formatResult(result.draw.first)" style="margin-left: 5px"></app-ball>
                    <app-ball *ngIf="result.draw.second" [background]="'red'" [size]="'tiny'"
                              [title]="this.formatResult(result.draw.second)" style="margin-left: 5px"></app-ball>
                    <app-ball *ngIf="result.draw.third" [background]="'red'" [size]="'tiny'"
                              [title]="this.formatResult(result.draw.third)" style="margin-left: 5px"></app-ball>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>


      <div style="margin-top: 5px" class="inner-content" nz-row [nzGutter]="5">
        <ng-container *ngIf="!isMobile">
          <div *ngFor="let panel of panels" [nzLg]="getPanelSize(24 / panels.length)" [nzXs]="24"
               class="col-style column bet-column "
               nz-col>
            <div class="bet-column-header">
              <div class="bet-column-header-title">
                <span>{{panel.title}}</span>
              </div>
              <div class="bet-column-header-columns">
                <div class="row-style panel-container" nz-row>
                  <div class="col-style center-column" nz-col nzSpan="6">LOT</div>
                  <div class="col-style center-column" nz-col nzSpan="7">NUM</div>
                  <div class="col-style center-column" nz-col nzSpan="7">MONTO</div>
                  <div class="col-style center-column last-column" nz-col nzSpan="4"></div>
                </div>
              </div>
            </div>
            <div class="bet-column-body">
              <div *ngFor="let bet of getFilteredBets(panel.types)" class="bet">
                <div class="row-style panel-container" nz-row>
                  <div class="col-style center-column" nz-col nzSpan="6">{{bet.lotteryNickName}}</div>
                  <div class="col-style center-column" nz-col nzSpan="7">{{showParsedNumbers(bet.playNumbers)}}</div>
                  <div class="col-style center-column" nz-col nzSpan="7">${{bet.amount}}</div>
                  <div class="col-style center-column last-column" nz-col nzSpan="4">
                    <i (click)="deleteBet(bet)" class="action-icon error" nz-icon nzTheme="outline" nzType="delete"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="bet-column-footer">
              <span class="counter">{{getFilteredBets(panel.types).length}}</span>
              <span class="amount">${{getSumBets(getFilteredBets(panel.types))}}</span>
            </div>
          </div>
        </ng-container>
        <ng-container *ngIf="isMobile">
          <div class="bet-column">
            <div class="bet-column-header">
              <div class="bet-column-header-columns">
                <div class="row-style panel-container" nz-row>
                  <div class="col-style center-column" nz-col nzSpan="6">LOT</div>
                  <div class="col-style center-column" nz-col nzSpan="7">NUM</div>
                  <div class="col-style center-column" nz-col nzSpan="7">MONTO</div>
                  <div class="col-style center-column last-column" nz-col nzSpan="4"></div>
                </div>
              </div>
            </div>
            <div class="bet-column-body">
              <div *ngFor="let bet of plays" class="bet">
                <div class="row-style panel-container" nz-row>
                  <div class="col-style center-column" nz-col nzSpan="6">{{bet.lotteryNickName}}</div>
                  <div class="col-style center-column" nz-col nzSpan="7">{{showParsedNumbers(bet.playNumbers)}}</div>
                  <div class="col-style center-column" nz-col nzSpan="7">${{bet.amount}}</div>
                  <div class="col-style center-column last-column" nz-col nzSpan="4">
                    <i (click)="deleteBet(bet)" class="action-icon error" nz-icon nzTheme="outline" nzType="delete"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>

    </nz-content>
  </nz-layout>
</nz-layout>


<nz-modal
  [(nzVisible)]="modalConfirm"
  [nzContent]="modalContent"
  [nzFooter]="modalFooter"
  [nzTitle]="modalTitle"
  nzTitle="Modal"
>
  <ng-template #modalTitle>
    <ng-container *ngIf="!generatedBet">Estas seguro?</ng-container>
    <ng-container *ngIf="generatedBet">Apuesta realizada con exito!</ng-container>
  </ng-template>
  <ng-template #modalContent>
    <ng-container *ngIf="loadingSubmit">
      <div class="lottery-loading">
        <i nz-icon nzTheme="outline" nzType="loading"></i>
      </div>
    </ng-container>
    <ng-container *ngIf="generatedBet">
      <span class="modal-confirm-total">
        <i nz-icon nzTheme="outline" nzType="shopping-cart"></i>
        TOTAL: ${{getSumBets(generatedBet.plays)}}
      </span>
      <span *ngIf="generatedBet._id" class="modal-confirm-ticket-number">
        APUESTA: {{generatedBet._id.toString()}}
      </span>
      <div class="modal-confirm-buttons">
        <a *ngIf="canSeeSn(generatedBet)" [href]="getSendWhatsApp(generatedBet)" target="_blank">
          <div class="custom-button-confirm" nz-tooltip="Enviar por whatsapp">
            <i class="icon primary" nz-icon nzTheme="outline" nzType="whats-app"></i>
          </div>
        </a>
        <div *ngIf="!isMobile; else mobile">
          <div *ngIf="canSeeSn(generatedBet)" (click)="printTicket(generatedBet)" class="custom-button-confirm"
               nz-tooltip="Imprimir">
            <i class="icon primary" nz-icon nzTheme="outline" nzType="printer"></i>
          </div>
        </div>
        <ng-template #mobile>
          <div style="width: 100%; text-align: center" class="custom-button-confirm">
        <span style="color: blue;cursor: pointer" *ngIf="canSeeSn(generatedBet)" (click)="shareTicket(generatedBet)">
          <i class="icon primary" nz-icon nzTheme="outline" nzType="printer"></i>
        </span>
          </div>
        </ng-template>
      </div>
    </ng-container>
    <ng-container *ngIf="!generatedBet && !loadingSubmit">
      <h3 style="text-align: center">Desea confirmar la apuesta?</h3>
    </ng-container>
  </ng-template>
  <ng-template #modalFooter>
    <div class="modal-confirm-footer">
      <button (click)="closeModalConfirm()" [disabled]="loadingSubmit" nz-button nzType="default">Cerrar</button>
      <button (click)="onSubmitBetConfirm()" *ngIf="!generatedBet"
              [disabled]="loadingSubmit"
              [nzLoading]="loadingSubmit"
              nz-button
              nzType="primary">Confirmar ticket
      </button>
    </div>
  </ng-template>
</nz-modal>


<app-drawer-bets
  #drawerBets
  [nzTitle]="'BUSCAR TICKET'"
  [canSeeSn]="canSeeSn"
  [banking]="banking"
  [getSendWhatsApp]="getSendWhatsApp"
  [openTicket]="openTicket"
  [cloneTicket]="cloneTicket"
  [canCancelTicket]="canCancelTicket"
></app-drawer-bets>

<app-drawer-bet
  #drawerBet
  [nzTitle]="'VER TICKET'"
  [banking]="banking"
  [canSeeSn]="canSeeSn"
  [getSendWhatsApp]="getSendWhatsApp"
  [cloneTicket]="cloneTicket"
></app-drawer-bet>


<app-drawer-help
  #drawerHelp
  [nzTitle]="'AYUDA'"
></app-drawer-help>

<app-drawer-chat
  #drawerChat
  [nzTitle]="'CHAT'"
></app-drawer-chat>

<app-drawer-lotteries
  #drawerLotteryLimits
  [nzTitle]="'LIMITES DE LOTERIAS'"
  [availableBettingPlays]="availableBettingPlays"
  [availablePlays]="availablePlays"
></app-drawer-lotteries>


<app-drawer-pay-bet
  #drawerPayBet
  [nzTitle]="'PAGAR TICKET'"
></app-drawer-pay-bet>


<app-drawer-resume-sells
  #drawerResumeSells
  [nzTitle]="'RESUMEN DE VENTAS'"
></app-drawer-resume-sells>
